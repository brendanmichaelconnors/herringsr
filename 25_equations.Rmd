# Model description

The Pacific Herring stock assessment is conducted using the integrated statistical catch age model [iSCAM; @martell2011]. 
iSCAM is implemented in a Bayesian estimation framework and is written in AD Model Builder [@admb].
The original source code and documentation for iSCAM and AD Model Builder are available online. 

This section contains the documentation in mathematical form of the underlying iSCAM
age-structured model, its steady state version that is used to calculate reference points, the
observation models used in predicting observations, and the components of the objective
function that formulate the statistical criterion used to estimate model parameters.
This section will not be included in the final document.

A documented list of symbols used in model equations is given in Table \@ref(tab:variables). 
The documentation presented here is a revised version of the iSCAM user guide available online. 
Much of the text and many of the equations have been taken directly from the original iSCAM user guide.
Note that all the model equations are presented for a sex structured model with $S$ sexes.
Models can therefore be constructed with data for females only, for males and females, or with unsexed data.

This section describes all features of iSCAM, some of which however are not implemented for the Pacific Herring stock assessment.
Note that we refer to iSCAM as a statistical catch-age (SCA) model in the main text.
The following list describes modifications specific to the assessment of Pacific Herring:
  
1. Data are unsexed, $S = 1$,

2. Total mortality is constant across ages, $Z_{t,a} = Z_t$,

3. Fecundity and maturity are synonymous and used interchangeably,

4. Total mortality (i.e., 100% of $Z_t$) occurs prior to spawning, and

5. Unfished spawning biomass is represented as $B_0$ in this section, and as $\mli{SB}_0$ in
the main text.

## Equilibrium considerations: steady-state age structured model

Pacific Herring steady-state age-structured model assuming
unequal vulnerability-at-age,
age-specific fecundity, and
Beverton-Holt recruitment. 
Under steady state conditions the parameter vector 
$\Theta$ is assumed to be unknown and can be estimated by fitting the SCA model to 
data, with some restrictions:
  
\begin{equation}\label{eq:Theta-steady}
\Theta = \left(R_0,\,h,\,M\right);\quad
R_0 > 0,\,\,
0.2 \leq h < 1.0,\,\,
M > 0.
\end{equation}

For a given set of growth and maturity-at-age parameters $\Phi$
growth is assumed to follow the Von-Bertalanffy growth model, which describes
the observed length-at-age $l_{a,s}$.
The mean weight-at-age $w_{a,s}$ is given by an allometric relationship,
and age-specific vulnerability $v_a$ is given by an age-based logistic function.

\begin{equation}\label{eq:Phi}
\Phi = \left(l_{\infty,s},\,\acute{k}_s,\,t_{0,s},\,\acute{a}_s,\,
  \acute{b}_s,\,\dot{a}_s,\,\dot{\gamma}_s,\,\hat{a}_k,\,\hat{\gamma}_k\right)
\end{equation}

\begin{equation}\label{eq:l-as}
l_{a,s} = l\left(1-e^{\left(-k_s\left(a-t_{0,s}\right)\right)}\right)
\end{equation}

\begin{equation}\label{eq:w-as}
w_{a,s} = \acute{a}_s\left(l_{a,s}\right)^{\acute{b}_s}
\end{equation}

\begin{equation}\label{eq:v-a}
v_a = \left(1+e^{\left(\frac{-\left(\hat{a}-a\right)}{\hat{\gamma}}\right)}\right)^{-1}
\end{equation}

The terms vulnerability and selectivity are used interchangeably throughout this document, although technically,
selectivity refers to the fishing gear, while
vulnerability refers to all processes affecting the availability of fish to the fishery.
Selectivity parameters can be fixed or estimated.
Fecundity-at-age $f_{a,s}$ is defined in terms of weight-at-age and an age-based logistic function: 
  
  \begin{equation}\label{eq:f-as}
f_{a,s}=w_{a,s}\left(1+e^{\left(\frac{-\left(\dot{a}_s-a_s\right)}
                                 {\dot{\gamma}_s}\right)}\right)^{-1}
\end{equation}

Survivorship for unfished and fished populations is 
defined by Equations \@ref(eq:iota-a-1) and \@ref(eq:iota-a-2), 
respectively and it is assumed that all individuals ages $A$ and 
older (i.e., the plus group) have the same total mortality rate.

\begin{equation}\label{eq:iota-a-1}
\iota_a = \begin{cases}
\frac{1}{S}, & a=\acute{a}\\
\iota_{a-1}e^{-M}, & \acute{a}<a<A\\
\frac{\iota_{a-1}}{\left(1-e^{-M}\right)}, & a=A\\
\end{cases}
\end{equation}

\begin{equation}\label{eq:iota-a-2}
\iota_a = \begin{cases}
\frac{1}{S}, & a=\acute{a}\\
\hat{\iota}_{a-1,s}e^{-M-F_ev_{a-1,s}}, & \acute{a}<a<A\\
\frac{\hat{\iota}_{a-1,s}e^{-M-F_ev_{a-1,s}}}{1-e^{-M-F_e v_{a,s}}}, & a=A\\
\end{cases}
\end{equation}

The incidence functions refer to the life-time or per-recruit quantities such as spawning biomass per recruit (Equation \ref{eq:phi-E}) or vulnerable biomass per recruit (Equation \ref{eq:phi-B}).
Note that upper and lower case subscripts denote unfished and fished conditions, respectively.

\begin{equation}\label{eq:phi-E}
\phi_E = \sum_{s=1}^S\sum_{a=\acute{a}}^A \iota_a f_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-e}
\phi_e = \sum_{s=1}^S\sum_{a=\acute{a}}^A \hat{\iota}_{a,s} f_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-B}
\phi_B = \sum_{s=1}^S\sum_{a=\acute{a}}^A \iota_a w_{a,s} v_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-b}
\phi_b = \sum_{s=1}^S\sum_{a=\acute{a}}^A \hat{\iota}_{a,s} w_{a,s} v_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-q}
\phi_q = \sum_{s=1}^S\sum_{a=\acute{a}}^A
\frac{\hat{\iota}_{a,s} w_{a,s} v_{a,s}}{M+F_ev_{a,s}}
\left(1-e^{\left(-M-F_ev_{a,s}\right)}\right)
\end{equation}

Unfished spawning biomass $B_0$ and the recruitment 
compensation ratio $\kappa$ [@myers1999] are estimated by:
  
  \begin{equation}\label{eq:B-0}
B_0 = R_0\phi_B
\end{equation}

\begin{equation}\label{eq:kappa}
\kappa=\frac{4h}{1-h}
\end{equation}

Recruitment is assumed to follow a Beverton-Holt 
stock recruitment relationship,
where the maximum juvenile survival rate $\alpha$ 
and the density-dependent term $\beta$ are given by:
  
\begin{equation}\label{eq:alpha}
\alpha = \frac{\kappa}{\phi_E}  
\end{equation}

\begin{equation}\label{eq:beta}
\beta=\frac{\kappa-1}{R_0\phi_E}
\end{equation}

These equations can then be simplified to the
steady-state equilibrium recruitment $R_e$ needed to calculate 
the equilibrium yield $C_e$ for a given fishing mortality rate $F_e$:
  <!-- SH - write something about phi_q? -->
  
  \begin{equation}\label{eq:R-e}
R_e = R_0 \frac{\kappa-\frac{\phi_E}{\phi_e}}{\kappa-1}  
\end{equation}

\begin{equation}\label{eq:C-e}
C_e = F_e R_e \phi_q
\end{equation}

These steady-state conditions are critical for 
determining various reference points such as
$F_\text{MSY}$ and $B_\text{MSY}$. iSCAM calculates 
$F_\text{MSY}$ by finding the value of 
$F_e$ that results in the zero derivative of Equation \@ref(eq:C-e).
This is accomplished numerically using a Newton-Raphson method 
where an initial guess for
$F_\text{MSY}$ is set equal to $M$. 
Given an estimate of $F_\text{MSY}$, other reference points such as $MSY$ and
$B_\text{MSY}$ can be calculated. However, these reference points 
are not currently used in the Pacific Herring assessment.

## Dynamic state: statistical catch-age model

The estimated parameter vector in the 
dynamic state version of iSCAM is defined by $\Theta$,
where $R_0$, $h$, and $M$, are the leading population 
parameters that define the overall scale and 
productivity of the population. 

\begin{equation}\label{eq:Theta-catch}
\Theta = \left(R_0,\,h,\,M,\,\overline{R},\,\overline{R}_{\mli{init}},\,\vartheta^2,\,\rho,\,
               \Gamma_{k,t},\,\{\omega_t\}_{\acute{t}=1-A}^{\acute{t}=T},\,
               \{\omega_{\mli{init},t}\}_{t=\acute{t}-A}^{t=\acute{t}-1}\right)
\end{equation}

The variance components of the model are partitioned using an errors in variables approach. 
The key variance parameter is the inverse of the total variance $\vartheta^2$ (i.e., total precision).
This parameter can be fixed or estimated, and was fixed for this model.
The total variance is partitioned into observation $\sigma$ and process error $\tau$ components by the model parameter $\rho$,
which represents the proportion of the total variance that is due to observation error [@punt1999; @deriso2007].

\begin{equation}\label{eq:sigma}
\sigma = \sqrt{\rho}\vartheta
\end{equation}

\begin{equation}\label{eq:tau}
\tau = \sqrt{\left(1-\rho\right)}\vartheta  
\end{equation}

The unobserved state variables (Equation \ref{eq:N-tas-unobs})
include the numbers-at-age each year $N_{t,a,s}$,
the spawning stock biomass $B_{t,s}$, 
and the total age-specific total mortality rate $Z_{t,a,s}$.

\begin{equation}\label{eq:N-tas-unobs}
N_{t,a,s},\,\, SB_{t,s},\,\, B_{t,s},\,\, Z_{t,a,s}
\end{equation}

Initial numbers-at-age in the first year (Equation \ref{eq:N-tas-init-1}) and
the annual recruits (Equation \ref{eq:N-tas-init-2})
are treated as estimated parameters and used to initialize the numbers-at-age array.
\begin{equation}\label{eq:N-tas-init-1}
N_{t,a,s} = \frac{1}{S}\overline{R}_\mli{init}e^{\omega_{\mli{init},t}}e^{-M\left(a-1\right)};\quad
\left(\acute{t}-A\right) < t < 1,\,\,
\acute{a} \leq a \leq A
\end{equation}

\begin{equation}\label{eq:N-tas-init-2}
N_{t,a,s} = \frac{1}{S}\bar{R}e^{\omega_{t}};\quad
\acute{t} \leq t \leq T;\,\,
a = \acute{a}.  
\end{equation}

Vulnerability-at-age $v_{k,a}$ is assumed to be time-invariant and is modelled using a two-parameter logistic function (Equation \ref{eq:v-ka}).
The annual fishing mortality for each gear $k$ in year $t$ is the exponent of the estimated vector $\Gamma_{k,t}$ (Equation \ref{eq:F-kt}).
The vector of log fishing mortality rate parameters $\Gamma_{k,t}$ is a bounded vector with a 
minimum value of $-30.0$ and a maximum value of $3.0$.
In arithmetic space this corresponds to a
minimum value of $9.36^{-14}$ and a maximum value of $20.01$ for annual fishing mortality rates.
In years where there are zero reported catches for a given fleet,
no corresponding fishing mortality rate parameter is estimated and the implicit assumption is there was no fishery in that year.

\begin{equation}\label{eq:v-ka}
v_{k,a} = \frac{1}{1+e^{-\frac{\left(a - \hat{a}_k\right)}{\hat{\gamma}_k}}}  
\end{equation}

\begin{equation}\label{eq:F-kt}
F_{k,t} = e^{\Gamma_{k,t}}
\end{equation}

State variables in each year are updated using 
Equations \@ref(eq:B-ts-state) to \@ref(eq:N-tas-state),
where the spawning biomass is the product of the 
numbers-at-age and the mature biomass-at-age 
(Equation \ref{eq:B-ts-state}). The total mortality rate 
is given by Equation \@ref(eq:Z-tas-state), and the total 
catch (in weight) for each gear is given by Equation \@ref(eq:C-kt), 
assuming that both natural and fishing mortality 
occur simultaneously throughout the year. The sex-specifc 
numbers-at-age are propagated over time using 
(Equation \ref{eq:N-tas-state}), where members of the plus group
(age A) are all assumed to have the same total mortality 
rate $Z_{t,a,s}$. 

\begin{equation}\label{eq:B-ts-state}
\mli{B}_{t,s} = \sum_{a=\acute{a}}^A N_{t,a,s}f_{a,s}
\end{equation}

\begin{equation}\label{eq:Z-tas-state}
Z_{t,a,s} = M+\sum_{k=1}^K F_{k,t} v_{k,t,a,s}
\end{equation}

\begin{equation}\label{eq:C-kt}
\hat{C}_{k,t} = \sum_{s=1}^S \sum_{a=\acute{a}}^A \frac {N_{t,a,s}w_{a,s}F_{k,t}
v_{k,t,a,s} \left( 1-{e^{-Z_{t,a,s}}} \right) }{Z_{t,a,s}}^{\eta_t}
\end{equation}

\begin{equation}\label{eq:N-tas-state}
N_{t,a,s} = \begin{cases}
\frac{\alpha E_{t-1}}{1+\beta E_{t-1}} e^{\left(\omega_t-0.5\tau^2\right)}, & a=\acute{a}\\
N_{t-1,a-1,s} e^{\left(-Z_{t-1,a-1,s}\right)}, & \acute{a}<a<A\\
N_{t-1,a,s} e^{\left(-Z_{t-1,a,s}\right)}, & a=A\\
\end{cases}
\end{equation}

Recruitment to age k (where k in this case refers to the 
start age, which for Pacific Herring is age 2) is assumed 
to follow a Beverton-Holt model for Pacific herring 
(Equation \ref{eq:R-t}) where the maximum juvenile survival 
rate $\alpha$ is defined by Equation \@ref(eq:alpha) and 
$\beta$ is derived from Equation \@ref(eq:beta),
which is conditional on estimates of $h$ and $R_0$.

\begin{equation}\label{eq:R-t}
R_t = \frac{\alpha B_{t-k}}{1+\beta B_{t-k}}e^{\delta_{t}-0.5\tau^2}
\end{equation}

### Residuals, likelihoods, and objective function value components

The objective function contains five major components:

1. The negative log-likelihood for the catch data,

2. The negative log-likelihood for the relative abundance data,

3. The negative log-likelihood for the age composition data,

4. The prior distributions for model parameters, and

5. Three penalty functions that are invoked to regularize the solution during intermediate
phases of the non-linear parameter estimation. 

The penalty functions:

a. Constrain the estimates of annual recruitment to conform to a Beverton-Holt stock-recruit
function,

b. Weakly constrain the log recruitment deviations to a normal distribution, and

c. Weakly constrain estimates of log fishing mortality to a normal distribution
(N(ln(0:2); 4:0)) to prevent estimates of catch from exceeding estimated biomass.

Sensitivity analysis indicate that the model is insensitive 
to changes in the penalty function parameters, indicating that
the other likelihood components and prior probability distributions 
were the most important contributors to the objective function.

The objective function components are discussed in more detail in the following sections.

### Observed Catch

It is assumed that the measurement errors in the catch observations
are log-normally distributed, and the residuals given by:


\begin{equation}\label{eq:ets_kt}
\eta_{k,t} = ln(C_{k,t} + o) - ln(\hat{C}_{k,t} + o)
\end{equation}

where $o$ is a small constant ($e^{-10}$) to ensure the residual is 
defined in the case of a zero catch observation. The residuals 
are assumed to be normally distributed with a user-specified standard
deviation $\sigma_{C}$. At present, it is assumed that observed catches for each 
gear $k$ have the same standard deviation. The negative loglikelihood (ignoring the scaling constant) for the catch data is given by:

\begin{equation}\label{eq:ets_kt}
l_{C} = \sum_{k}[T_k ln(\sigma_{C})+
\frac{\sum_{t}(\eta_{k,t})^2}{2\sigma_{C}^2}] 
\end{equation}

where $T_k$ is the total number of catch observations for gear type $k$.


\begin{table}[ht]
\centering
\caption{\label{tab:variables}Description of symbols and constants in the
  Pacific Herring statistical catch-age model.}
\begin{tabular}{lll}
\toprule
\bf{Symbol} & \bf{Value} & \bf{Description}\\
\midrule
\multicolumn{3}{l}{\textbf{Indices}}\\
$s$ & & Index for sex\\
$a$ & & Index for age\\
$t$ & & Index for year\\
$k$ & & Index for gear\\
\multicolumn{3}{l}{\textbf{Model dimensions}}\\
$S$ & $`r major_models[[1]]$dat$num.sex`$ & Number of sexes\\
$\acute{a},\,A$ & $`r major_models[[1]]$dat$start.age`$, $`r major_models[[1]]$dat$end.age`$ & Youngest and oldest age class ($A$ is a plus group)\\
$\acute{t},\,T$ & $`r major_models[[1]]$dat$start.yr`$, $`r major_models[[1]]$dat$end.yr`$ & First and last year of catch data\\
$K$ & $`r major_models[[1]]$dat$num.gears`$ & Number of gears including survey gears\\
\multicolumn{3}{l}{\textbf{Observations (data)}}\\
$C_{k,t}$ & & Catch in weight for gear $k$ in year $t$\\
$I_{k,t}$ & & Relative abundance index for gear $k$ in year $t$\\
\multicolumn{3}{l}{\textbf{Estimated parameters}}\\
$R_0$ & & Age-$\acute{a}$ recruits in unfished conditions\\
$h$ & & Steepness of the stock-recruitment relationship\\
$\bar{R}$ & & Average age-$\acute{a}$ recruitment from year $\acute{t}$ to $T$\\
$\bar{R}_\mli{init}$ & & Average age-$\acute{a}$ recruitment in year $\acute{t}-1$\\
$M_s$ & & Instantaneous natural mortality rate\\
$\hat{a}_k$ & & Selectivity parameter for gear $k$\\
$\hat{\gamma}_k$ & & Selectivity parameter for gear $k$\\
$\Gamma_{k,t}$ & & Logarithm of the instantaneous fishing mortality for gear $k$ in year $t$\\
$\omega_t$ & & Age-$\acute{a}$ deviates from $\bar{R}$ for years $\acute{t}$ to $T$\\
$\omega_{\mli{init},t}$ & & Age-$\acute{a}$ deviates from $\bar{R}_\mli{init}$ in year $\acute{t}$\\
$q_k$ & & Catchability parameter for survey $k$\\
$\rho$ & & Fraction of the total variance associated with observation error\\
$\vartheta^2$ & & Total precision (inverse of variance) of the total error\\
\multicolumn{3}{l}{\textbf{Standard deviations}}\\
$\sigma$ & & Standard deviation for observation errors in survey index\\
$\tau$ & & Standard deviation in process errors (recruitment deviations)\\
$\sigma_{C,k}$ & & Standard deviation in observed catch for gear $k$\\
\multicolumn{3}{l}{\textbf{Residuals}}\\
$\delta_t$ & & Recruitment residual in year $t$\\
$\eta_t$ & & Residual error in predicted catch in year $t$\\
\multicolumn{3}{l}{\textbf{Fixed growth and maturity parameters}}\\
$l_{\infty,s}$ & & Asymptotic length in millimetres for sex $s$\\
$\acute{k}_s$ & & Brody growth coefficient for sex $s$\\
$t_{0,s}$ & & Theoretical age at zero length for sex $s$\\
$\acute{a}_s$ & & Scalar in length-weight allometry for sex $s$\\
$\acute{b}_s$ & & Power parameter in length-weight allometry for sex $s$\\
$\dot{a}_s$ & & Age at 50\% maturity for sex $s$\\
$\dot{\gamma}_s$ & & Standard deviation at 50\% maturity for sex $s$\\
\bottomrule
\end{tabular}
\end{table}