# Model description

The Pacific Herring stock assessment is conducted using the integrated statistical catch age model [ISCAM; @martell2011]. 
ISCAM is implemented in a Bayesian estimation framework and is written in AD Model Builder [@admb].
The original source code and documentation for both are available online. 

This section contains the documentation in mathematical form of the underlying ISCAM
age-structured model, its steady state version that is used to calculate reference points, the
observation models used in predicting observations, and the components of the objective
function that formulate the statistical criterion used to estimate model parameters.

A documented list of symbols used in model equations is given in Table \@ref(tab:variables). 
The documentation presented here is a revised version of the ISCAM user guide available online. 
Much of the text and many of the equations have been taken directly from the original ISCAM user guide.
Note that all the model equations are presented for a sex structured model with $S$ sexes.
Models can therefore be constructed with data for females only, for males and females, or with unsexed data.

This section describes all features of ISCAM, some of which however are not implemented for the Pacific Herring stock assessment.
Note that we refer to ISCAM as a statistical catch-age (SCA) model in the main text.
The following list describes modifications specific to the assessment of Pacific Herring:

1. Data are unsexed, $S = 1$.

2. Total mortality is constant across ages, $Z_{ta} = Z_t$.

3. Fecundity and maturity are synonymous and used interchangeably.

4. 100% of $Z_t$ occurs prior to spawning.

5. Unfished spawning biomass is represented as $B_0$ in this section, and as $\mli{SB}_0$ in
the main text.


## Steady-state age structured model

Pacific Herring steady-state age-structured model assuming
unequal vulnerability-at-age,
age-specific fecundity, and
Beverton-Holt recruitment.

The parameter vector, $\Theta$, under steady state conditions is assumed to be unknown,

\begin{equation}\label{eq:Theta-steady}
\Theta = \left(R_0,\,h,\,M\right)
\end{equation}

and can be estimated by fitting the SCA model to data with the following restrictions:
$R_0 > 0$, $0.2 \leq h < 1.0$, and $M > 0$. For a given set of growth and maturity-at-age parameters,

\begin{equation}\label{eq:Phi}
\Phi = \left(l_{\infty,s},\,\acute{k}_s,\,t_{0,s},\,\acute{a}_s,\,
\acute{b}_s,\,\dot{a}_s,\,\dot{\gamma}_s,\,\hat{a}_k,\,\hat{\gamma}_k\right)
\end{equation}

growth is assumed to follow the Von-Bertalanffy growth model, where the observed length-at-age $l_{a,s}$ is defined by: 

\begin{equation}\label{eq:l-as}
l_{a,s} = l\left(1-e^{\left(-k_s\left(a-t_{0,s}\right)\right)}\right)
\end{equation}

and the mean weight-at-age is given by an allometric relationship: 

\begin{equation}\label{eq:w-as}
w_{a,s} = \acute{a}_s\left(l_{a,s}\right)^{\acute{b}_s}
\end{equation}

and age-specific vulnerability is given by an age-based logistic function:

\begin{equation}\label{eq:v-a}
v_a = \left(1+e^{\left(\frac{-\left(\hat{a}-a\right)}{\hat{\gamma}}\right)}\right)^{-1}
\end{equation}

The terms vulnerability and selectivity are used interchangeably throughout this document, although, technically,
selectivity refers to the fishing gear, while
vulnerability refers to all processes affecting the availability of fish to the fishery.
Selectivity parameters can be fixed or estimated.

\begin{equation}\label{eq:f-as}
f_{a,s}=w_{a,s}\left(1+e^{\left(\frac{-\left(\dot{a}_s-a_s\right)}
{\dot{\gamma}_s}\right)}\right)^{-1}
\end{equation}

Survivorship for unfished and fished populations is defined by Equations \@ref(eq:iota-a-1) and \@ref(eq:iota-a-2), respectively.
It is assumed that all individuals ages $A$ and older (i.e., the plus group) have the same total mortality rate.

\begin{equation}\label{eq:iota-a-1}
\iota_a = \begin{cases}
\frac{1}{S}, & a=1\\
\iota_{a-1}e^{-M}, & 1<a<A\\
\frac{\iota_{a-1}}{\left(1-e^{-M}\right)}, & a=A\\
\end{cases}
\end{equation}

\begin{equation}\label{eq:iota-a-2}
\iota_a = \begin{cases}
\frac{1}{S}, & a=1\\
\hat{\iota}_{a-1,s}e^{-M-F_ev_{a-1,s}}, & 1<a<A\\
\frac{\hat{\iota}_{a-1,s}e^{-M-F_ev_{a-1,s}}}{1-e^{-M-F_e v_{a,s}}}, & a=A\\
\end{cases}
\end{equation}

The incidence functions refer to the life-time or per-recruit quantities such as spawning biomass per recruit (Equation \@ref(eq:phi-E)) or vulnerable biomass per recruit (Equation \@ref(eq:phi-B)).
Note that upper and lower case subscripts denote unfished and fished conditions, respectively.

\begin{equation}\label{eq:phi-E}
\phi_E = \sum_{s=1}^S\sum_{a=1}^\infty \iota_a f_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-e}
\phi_e = \sum_{s=1}^S\sum_{a=1}^\infty \hat{\iota}_{a,s} f_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-B}
\phi_B = \sum_{s=1}^S\sum_{a=1}^\infty \iota_a w_{a,s} v_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-b}
\phi_b = \sum_{s=1}^S\sum_{a=1}^\infty \hat{\iota}_{a,s} w_{a,s} v_{a,s}
\end{equation}

\begin{equation}\label{eq:phi-q}
\phi_q = \sum_{s=1}^S\sum_{a=1}^\infty
\frac{\hat{\iota}_{a,s} w_{a,s} v_{a,s}}{M+F_ev_{a,s}}
\left(1-e^{\left(-M-F_ev_{a,s}\right)}\right)
\end{equation}

## SH fixing this 
Unfished spawning biomass is given by,

\begin{equation}\label{eq:B-0}
\mli{B}_0 = R_0\phi_B
\end{equation}

and the recruitment compensation ratio [@myers1999] is given by,
\begin{equation}\label{eq:kappa}
\kappa=\frac{4h}{1-h}
\end{equation}


The steady-state equilibrium recruitment for a given fishing mortality rate $F_e$ is given by Equation 13.
### Beverton-Holt recruitment
Recruitment is assumed to follow a Beverton-Holt stock recruitment model,
where the maximum juvenile survival rate $\alpha$ is given by:
\begin{equation}\label{eq:Alpha}
\alpha = \frac{\kappa}{\phi_E}  
\end{equation}

and the density-dependent term $\beta$ is given by:
\begin{equation}\label{eq:beta}
\beta=\frac{\kappa-1}{R_0\phi_E}
\end{equation}

which simplifes to:
\begin{equation}\label{eq:R-e}
R_e = R_0 \frac{\kappa-\frac{\phi_E}{\phi_e}}{\kappa-1}  
\end{equation}

The equilibrium yield $C_e$ foragiven fshing mortality rate is given by
\begin{equation}\label{eq:C-e}
C_e = F_e R_e \phi_q
\end{equation}

These steady-state conditions are critical for determining various reference points such as
$F_\text{MSY}$ and $B_\text{MSY}$.

## Catch-age model

The Pacific Herring SCA model using the Baranov catch equation.

### Estimated parameters

\begin{equation}\label{eq:Theta-catch}
\Theta = \left(R_0,\,h,\,M,\,\overline{R},\,\overline{R}_{\mli{init}},\,\vartheta^2,\,\rho,\,
\Gamma_{k,t},\,\{\omega_t\}_{\acute{t}=1-A}^{\acute{t}=T},\,
\{\omega_{\mli{init},t}\}_{t=\acute{t}-A}^{t=\acute{t}-1}\right)
\end{equation}

\begin{equation}\label{eq:sigma}
\sigma = \sqrt{\rho}\vartheta
\end{equation}

\begin{equation}\label{eq:tau}
\tau = \sqrt{\left(1-\rho\right)}\vartheta  
\end{equation}

### Unobserved states

\begin{equation}\label{eq:N-tas-unobs}
N_{t,a,s}
\end{equation}

\begin{equation}\label{eq:B-ts-unobs}
\mli{B}_{t,s}
\end{equation}

\begin{equation}\label{eq:Z-tas-unobs}
Z_{t,a,s}
\end{equation}

### Initial states

\begin{equation}\label{eq:N-tas-init-1}
N_{t,a,s} = \frac{1}{S}\overline{R}_\mli{init}e^{\omega_{\mli{init},t}}e^{-M\left(a-1\right)}
\end{equation}

where $(\acute{t}-A) < t < 1$, and $2 \leq a \leq A$.   
 
\begin{equation}\label{eq:N-tas-init-2}
N_{t,a,s} = \frac{1}{S}\bar{R}e^{\omega_{t}}
\end{equation}

where $1 \leq t \leq T$, and $a = 1$.  

\begin{equation}\label{eq:v-ka}
v_{k,a} = \frac{1}{1+e^{-\frac{\left(a - \hat{a}_k\right)}{\hat{\gamma}_k}}}  
\end{equation}

\begin{equation}\label{eq:F-kt}
F_{k,t} = e^{\Gamma_{k,t}}
\end{equation}

### State dynamics ($t>1$)

\begin{equation}\label{eq:B-ts-state}
\mli{B}_{t,s} = \sum_a N_{t,a,s}f_{a,s}
\end{equation}

\begin{equation}\label{eq:Z-tas-state}
Z_{t,a,s} = M+\sum_k F_{k,t} v_{k,t,a,s}
\end{equation}

\begin{equation}\label{eq:C-kt}
\hat{C}_{k,t} = \sum_s \sum_a \frac {N_{t,a,s}w_{a,s}F_{k,t}
v_{k,t,a,s} \left( 1-{e^{-Z_{t,a,s}}} \right) }{Z_{t,a,s}}^{\eta_t}
\end{equation}

\begin{equation}\label{eq:N-tas-state}
N_{t,a,s} = \begin{cases}
\frac{\alpha E_{t-1}}{1+\beta E_{t-1}} e^{\left(\omega_t-0.5\tau^2\right)}, & a=1\\
N_{t-1,a-1,s} e^{\left(-Z_{t-1,a-1,s}\right)}, & 1<a<A\\
N_{t-1,a,s} e^{\left(-Z_{t-1,a,s}\right)}, & a=A\\
\end{cases}
\end{equation}

### Beverton-Holt recruitment model

\begin{equation}\label{eq:R-t}
R_t = \frac{\alpha B_{t-k}}{1+\beta B_{t-k}}e^{\delta_{t}-0.5\tau^2}
\end{equation}

\begin{table}[ht]
\centering
\caption{\label{tab:variables}Description of symbols and constants in the
Pacific Herring statistical catch-age model.}
\begin{tabular}{lll}
\toprule
\bf{Symbol} & \bf{Value} & \bf{Description}\\
\midrule
\multicolumn{3}{l}{\textbf{Indices}}\\
$s$ & & Index for sex\\
$a$ & & Index for age\\
$t$ & & Index for year\\
$k$ & & Index for gear\\
\multicolumn{3}{l}{\textbf{Model dimensions}}\\
$S$ & $`r major_models[[1]]$dat$num.sex`$ & Number of sexes\\
$\acute{a},\,A$ & $`r major_models[[1]]$dat$start.age`$, $`r major_models[[1]]$dat$end.age`$ & Youngest and oldest age class ($A$ is a plus group)\\
$\acute{t},\,T$ & $`r major_models[[1]]$dat$start.yr`$, $`r major_models[[1]]$dat$end.yr`$ & First and last year of catch data\\
$K$ & $`r major_models[[1]]$dat$num.gears`$ & Number of gears including survey gears\\
\multicolumn{3}{l}{\textbf{Observations (data)}}\\
$C_{k,t}$ & & Catch in weight for gear $k$ in year $t$\\
$I_{k,t}$ & & Relative abundance index for gear $k$ in year $t$\\
\multicolumn{3}{l}{\textbf{Estimated parameters}}\\
$R_0$ & & Age-$\acute{a}$ recruits in unfished conditions\\
$h$ & & Steepness of the stock-recruitment relationship\\
$\bar{R}$ & & Average age-$\acute{a}$ recruitment from year $\acute{t}$ to $T$\\
$\bar{R}_\mli{init}$ & & Average age-$\acute{a}$ recruitment in year $\acute{t}-1$\\
$M_s$ & & Instantaneous natural mortality rate\\
$\hat{a}_k$ & & Selectivity parameter for gear $k$\\
$\hat{\gamma}_k$ & & Selectivity parameter for gear $k$\\
$\Gamma_{k,t}$ & & Logarithm of the instantaneous fishing mortality for gear $k$ in year $t$\\
$\omega_t$ & & Age-$\acute{a}$ deviates from $\bar{R}$ for years $\acute{t}$ to $T$\\
$\omega_{\mli{init},t}$ & & Age-$\acute{a}$ deviates from $\bar{R}_\mli{init}$ in year $\acute{t}$\\
$q_k$ & & Catchability parameter for survey $k$\\
$\rho$ & & Fraction of the total variance associated with observation error\\
$\vartheta^2$ & & Total precision (inverse of variance) of the total error\\
\multicolumn{3}{l}{\textbf{Standard deviations}}\\
$\sigma$ & & Standard deviation for observation errors in survey index\\
$\tau$ & & Standard deviation in process errors (recruitment deviations)\\
$\sigma_{C,k}$ & & Standard deviation in observed catch for gear $k$\\
\multicolumn{3}{l}{\textbf{Residuals}}\\
$\delta_t$ & & Recruitment residual in year $t$\\
$\eta_t$ & & Residual error in predicted catch in year $t$\\
\multicolumn{3}{l}{\textbf{Fixed growth and maturity parameters}}\\
$l_{\infty,s}$ & & Asymptotic length in millimetres for sex $s$\\
$\acute{k}_s$ & & Brody growth coefficient for sex $s$\\
$t_{0,s}$ & & Theoretical age at zero length for sex $s$\\
$\acute{a}_s$ & & Scalar in length-weight allometry for sex $s$\\
$\acute{b}_s$ & & Power parameter in length-weight allometry for sex $s$\\
$\dot{a}_s$ & & Age at 50\% maturity for sex $s$\\
$\dot{\gamma}_s$ & & Standard deviation at 50\% maturity for sex $s$\\
\bottomrule
\end{tabular}
\end{table}
