# Tables

```{r data-input}
fixup_table_by_major <- function(tab, by = major_regions_short){
  # Order a table with the first column 'Year' and the rest being major regions
  # by the same order as the major_regions_short vector.
  # Also check if any columns are missing and add them, and set all NAs to 0
  if(any(!by %in% colnames(tab))){
    tab[by[!by %in% colnames(tab)]] <- NA
  }
  tab[is.na(tab)] <- 0
  tab[-1] <- apply(tab[-1], c(1,2), f)
  tab_no_yr <- tab[-1]
  tab_no_yr <- tab_no_yr[,match(by, names(tab_no_yr))]
  cbind(tab[1], tab_no_yr)
}

cap <- paste0("Input data for the ", assess_yr," Pacifc Herring stock assessment. The spawn index has two distinct periods defned by the dominant survey method: surface surveys (", major_start_yr, " to ", new_surv_yr - 1, "), and dive surveys (", new_surv_yr, " to ", major_end_yr, "). The 'spawn index' represents the raw survey data only, and is not scaled by the spawn survey scaling parameter, q.")
tab <- inp_catch
# Following needed for french to work but some phrases not in dictionary. TODO
#tab <- apply(tab, c(1,2), en2fr, french)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           caption = cap)
```

```{r annual-catch}
cap <- "Total landed catch in tonnes of Pacifc Herring in the major stock assessment areas. Legend: Haida Gwaii (HG), Prince Rupert District (PRD), Central Coast (CC), Strait of Georgia (SoG), and West Coast of Vancouver Island (WCVI). Note: ‘WP’ indicates that data are withheld due to privacy concerns."
tab <- major_catch %>% 
  filter(year >= 2009) %>% 
  select(c(year, value, region)) %>% 
  group_by(year, region) %>% 
  summarize(catch = sum(value) * 1000) %>% 
  ungroup() %>% 
  reshape2::dcast(year ~ region, value.var = "catch") %>% 
  rename(Year = year)
tab <- fixup_table_by_major(tab)
names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", 5)),
           caption = cap)
```

```{r annual-spawn-on-kelp}
cap <- "Total spawn-on-kelp harvest in pounds of Pacifc Herring in the major stock assessment areas. Legend: Haida Gwaii (HG), Prince Rupert District (PRD), Central Coast (CC), Strait of Georgia (SoG), and West Coast of Vancouver Island (WCVI). Note: ‘WP’ indicates that data are withheld due to privacy concerns."

tab <- sok %>% 
  filter(Year >= 2009) %>% 
  select(c(Year, Harvest, Region)) %>% 
  group_by(Year, Region) %>% 
  summarize(catch = sum(Harvest) * 2.20462262185) %>% 
  ungroup() %>% 
  reshape2::dcast(Year ~ Region, value.var = "catch") %>% 
  select(-minor_regions_short)
tab <- fixup_table_by_major(tab)
tab$PRD[tab$Year == 2016] <- "WP"
names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", 5)),
           caption = cap)

```

```{r spawn-index-hg}
cap <- "Spawn index in tonnes (t), and proportion of the spawn index by Section within Statistical Area 02 for Pacifc Herring in the Haida Gwaii major stock assessment region. The spawn index is the annual total for the earliest year indicated in the 'Year(s)' column. Proportions indicate the proportion by year, or mean proportion over years, where year(s) are specifed in the ‘Year(s)’ column. The 'spawn index' represents the raw survey data only, and is not scaled by the spawn survey scaling parameter, q."

tab <- ps$HG
names(tab) <- gsub("&", "\\\\&", names(tab))
tab[-c(1, 2)] <- apply(tab[-c(1, 2)], c(1,2), f, 3)
tab[2] <- apply(tab[2], c(1,2), f)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", ncol(tab) - 1)),
           caption = cap)

```

```{r spawn-index-prd}
cap <- "Spawn index in tonnes (t), and proportion of the spawn index by Statistical Area for Pacifc Herring in the Central Coast major stock assessment region. See Table \\\\@ref(tab:spawn-index-hg) for description."

tab <- ps$PRD
names(tab) <- gsub("&", "\\\\&", names(tab))
tab[-c(1, 2)] <- apply(tab[-c(1, 2)], c(1,2), f, 3)
tab[2] <- apply(tab[2], c(1,2), f)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", ncol(tab) - 1)),
           caption = cap)

```

```{r spawn-index-cc}
cap <- "Spawn index in tonnes (t), and proportion of the spawn index by Statistical Area for Pacifc Herring in the Central Coast major stock assessment region. See Table \\\\@ref(tab:spawn-index-hg) for description."

tab <- ps$CC
names(tab) <- gsub("&", "\\\\&", names(tab))
tab[-c(1, 2)] <- apply(tab[-c(1, 2)], c(1,2), f, 3)
tab[2] <- apply(tab[2], c(1,2), f)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", ncol(tab) - 1)),
           caption = cap)

```

```{r spawn-index-sog}
cap <- "Spawn index in tonnes (t), and proportion of the spawn index by Group for Pacifc Herring in the Strait of Georgia major stock assessment region. Legend: '14\\&17' is Statistical Areas 14 and 17 (excluding Section 173); 'ESoG' is eastern Strait of Georgia; 'Lazo' is above Cape Lazo; and 'SDodd' is South of Dodd Narrows. See Table \\\\@ref(tab:spawn-index-hg) for description."

tab <- ps$SOG
names(tab) <- gsub("&", "\\\\&", names(tab))
tab[-c(1, 2)] <- apply(tab[-c(1, 2)], c(1,2), f, 3)
tab[2] <- apply(tab[2], c(1,2), f)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", ncol(tab) - 1)),
           caption = cap)

```

```{r spawn-index-wcvi}
cap <- "Spawn index in tonnes (t), and proportion of the spawn index by Statistical Area for Pacifc Herring in the West Coast of Vancouver Island major stock assessment region. See Table \\\\@ref(tab:spawn-index-hg) for description."

tab <- ps$WCVI
names(tab) <- gsub("&", "\\\\&", names(tab))
tab[-c(1, 2)] <- apply(tab[-c(1, 2)], c(1,2), f, 3)
tab[2] <- apply(tab[2], c(1,2), f)
#names(tab) <- en2fr(names(tab), french)
csas_table(tab,
           format = "latex",
           align = c("l", rep("r", ncol(tab) - 1)),
           caption = cap)

```

```{r ref-points, results = 'asis', echo = FALSE}
cap <- paste0("Posterior (5\\textsuperscript{th} percentile, Median, and ",
              "95\\textsuperscript{th} percentile) estimates of proposed reference ",
              "points for the Haida Gwaii model. $\\mli{SB}_{2019}$ represents prefishery spawning biomass, ",
              "and all biomass numbers are in thousands of tonnes. Probability of ",
              "$\\mli{SB}_{2019} < 0.3\\mli{SB}_0$ is based on zero catch.")
model_ind <- match("HG", major_regions_short)
make.ref.points.table(major_models[[model_ind]],
                      xcaption = cap,
                      xlabel = "tab:hg-ref-points",
                      font.size = 11,
                      space.size = 12,
                      placement = "H")
```
